<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>FX Rates (5-min)</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 1rem; }
        #chart, #spreads { width: 100%; max-width: 1200px; height: 48vh; margin: 0 auto 1rem; }
        .bar { max-width: 1200px; margin: 0 auto 0.5rem; display: flex; gap: .5rem; align-items: center; }
        .btn { padding: .4rem .7rem; border-radius: .5rem; border: 1px solid #ddd; cursor: pointer; background: #fafafa; }
        .btn.active { background: #e9f0ff; border-color: #bcd0ff; }
        .note { color: #555; }
    </style>
</head>
<body>
<h2>FX Rates (updated every 5 minutes)</h2>
<div class="bar">
    <div class="note">Window: 5:00 AM–4:00 PM PT • Visa=blue, MC=red, Wise=green • Data retention: 30 days</div>
</div>
<div class="bar">
    <button class="btn" data-range="today">Today</button>
    <button class="btn" data-range="2d">2d</button>
    <button class="btn" data-range="5d">5d</button>
    <button class="btn" data-range="30d">30d</button>
</div>

<div id="chart"></div>
<div id="spreads"></div>

<script>
    const TZ = 'America/Los_Angeles';

    async function loadData() {
        const res = await fetch('data.json', { cache: 'no-cache' });
        return res.ok ? res.json() : [];
    }

    // Helpers
    function toPTDateString(iso) {
        const d = new Date(iso);
        const fmt = new Intl.DateTimeFormat('en-CA', { timeZone: TZ, year: 'numeric', month: '2-digit', day: '2-digit' });
        return fmt.format(d); // YYYY-MM-DD
    }
    function ptMidnight(date) {
        // returns [start,end) ISO strings for that PT calendar day
        const z = new Date(date);
        const y = new Intl.DateTimeFormat('en', { timeZone: TZ, year: 'numeric' }).format(z);
        const m = new Intl.DateTimeFormat('en', { timeZone: TZ, month: '2-digit' }).format(z);
        const d = new Intl.DateTimeFormat('en', { timeZone: TZ, day: '2-digit' }).format(z);
        const start = new Date(`${y}-${m}-${d}T00:00:00-08:00`); // offset gets corrected by DST below
        // Rebuild with correct offset using the timeZone option
        const startMs = new Date(new Date(start).toLocaleString('en-US', { timeZone: TZ })).getTime();
        const endMs   = startMs + 24*60*60*1000 - 1;
        return [new Date(startMs).toISOString(), new Date(endMs).toISOString()];
    }
    function computeRange(tag) {
        const now = new Date();
        if (tag === 'today') return ptMidnight(now);
        const days = tag === '2d' ? 2 : tag === '5d' ? 5 : 30;
        const [endStart] = ptMidnight(now);
        const end = new Date(endStart); end.setUTCDate(end.getUTCDate() + 1); // exclusive end = tomorrow PT midnight
        const start = new Date(end); start.setUTCDate(start.getUTCDate() - days);
        return [start.toISOString(), end.toISOString()];
    }

    function filterByRange(data, [startIso, endIso]) {
        const start = new Date(startIso).getTime();
        const end   = new Date(endIso).getTime();
        return data.filter(d => {
            const t = new Date(d.ts).getTime();
            return t >= start && t < end;
        });
    }

    function drawAll(data, [xStart, xEnd]) {
        const ts   = data.map(d => d.ts);
        const visa = data.map(d => d.visa);
        const mc   = data.map(d => d.mc);
        const wise = data.map(d => d.wise);

        Plotly.newPlot('chart', [
            { x: ts, y: visa, mode: 'lines', name: 'Visa', line: { color: 'blue',  width: 2 } },
            { x: ts, y: mc,   mode: 'lines', name: 'MC',   line: { color: 'red',   width: 2 } },
            { x: ts, y: wise, mode: 'lines', name: 'Wise', line: { color: 'green', width: 2 } },
        ], {
            margin: { t: 10, r: 10, l: 50, b: 40 },
            xaxis: { title: 'Time (PT)', type: 'date', range: [xStart, xEnd] },
            yaxis: { title: 'Rate' },
            hovermode: 'x unified'
        }, {responsive: true});

        Plotly.newPlot('spreads', [
            { x: ts, y: data.map(d => d.spread_mc),   mode: 'lines', name: 'Wise - MC',   line: { width: 2 } },
            { x: ts, y: data.map(d => d.spread_visa), mode: 'lines', name: 'Wise - Visa', line: { width: 2 } },
        ], {
            margin: { t: 10, r: 10, l: 50, b: 40 },
            xaxis: { title: 'Time (PT)', type: 'date', range: [xStart, xEnd] },
            yaxis: { title: 'Spread' },
            hovermode: 'x unified'
        }, {responsive: true});
    }

    async function init() {
        let raw = await loadData();

        const btns = Array.from(document.querySelectorAll('.btn'));
        let active = 'today';

        function apply(tag) {
            active = tag;
            btns.forEach(b => b.classList.toggle('active', b.dataset.range === tag));
            const xr = computeRange(tag);
            drawAll(filterByRange(raw, xr), xr);
        }

        apply('today');

        btns.forEach(b => b.addEventListener('click', () => apply(b.dataset.range)));

        setInterval(async () => {
            raw = await loadData();
            apply(active);
        }, 60_000);
    }
    init();
</script>
</body>
</html>
