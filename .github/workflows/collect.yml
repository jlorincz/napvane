name: Collect FX rates

on:
  schedule:
    - cron: "* * * * *"   # every minute (UTC)
  workflow_dispatch: {}

jobs:
  collect:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # allow push with GITHUB_TOKEN

    steps:
      - name: Check out
        uses: actions/checkout@v4

      - name: Gate to PT window
        id: gate
        run: |
          PT_HOUR=$(TZ=America/Los_Angeles date +%H)
          if [ "$PT_HOUR" -ge 5 ] && [ "$PT_HOUR" -lt 16 ]; then
            echo "in_window=true" >> $GITHUB_OUTPUT
          else
            echo "in_window=false" >> $GITHUB_OUTPUT
          fi

      - name: Install jq
        if: steps.gate.outputs.in_window == 'true'
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run nap() and append point
        if: steps.gate.outputs.in_window == 'true'
        env:
          WISE_TOKEN: ${{ secrets.WISE_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          . scripts/rates.sh
          OUT=$(nap)

          mc_rate=$(echo "$OUT" | awk 'NR>1 && $1=="mc"{print $2}')
          visa_rate=$(echo "$OUT" | awk 'NR>1 && $1=="visa"{print $2}')
          wise_rate=$(echo "$OUT" | awk 'NR>1 && $1=="wise"{print $2}')

          if [ -z "${mc_rate:-}" ] || [ -z "${visa_rate:-}" ] || [ -z "${wise_rate:-}" ]; then
            echo "Missing a rate in nap() output; not writing."
            echo "$OUT"
            exit 0
          fi

          TS=$(TZ=America/Los_Angeles date -Iseconds)
          mkdir -p docs
          [ -f docs/data.json ] || echo "[]" > docs/data.json

          tmp=$(mktemp)
          jq --arg ts "$TS" \
             --arg mc "$mc_rate" \
             --arg visa "$visa_rate" \
             --arg wise "$wise_rate" '
            . + [{
              ts: $ts,
              mc:   ($mc   | tonumber),
              visa: ($visa | tonumber),
              wise: ($wise | tonumber),
              spread_mc:   (($wise | tonumber) - ($mc   | tonumber)),
              spread_visa: (($wise | tonumber) - ($visa | tonumber))
            }] | (.[-19800:] // .)   # 30 days @ 5-min cadence
          ' docs/data.json > "$tmp"
          mv "$tmp" docs/data.json

      - name: Commit & push if changed
        if: steps.gate.outputs.in_window == 'true'
        run: |
          git config user.name "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git add docs/data.json
          if ! git diff --cached --quiet; then
            git commit -m "data: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            git push
          else
            echo "No changes"
          fi
